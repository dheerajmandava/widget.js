var Proovd=function(i){"use strict";class t{constructor(i){this.assignedVariant=null,this.campaign=i}isProductPage(){const{productHandle:i,productUrl:t}=this.campaign.pricingConfig,n=window.location.href,a=window.location.pathname;return!(!i||!a.includes(`/products/${i}`))||(!(!t||!n.includes(t))||!!a.match(/\/products\/[^\/]+$/))}getAssignedVariant(){const i=`proovd_pricing_${this.campaign.id}`,t=localStorage.getItem(i);if(t)try{const i=JSON.parse(t),n=this.campaign.pricingConfig.variants.find(t=>t.variantId===i.variantId);if(n)return this.assignedVariant=n,n}catch(i){}const n=this.selectVariantByTraffic();return this.assignedVariant=n,localStorage.setItem(i,JSON.stringify({variantId:n.variantId,assignedAt:Date.now()})),n}selectVariantByTraffic(){const i=this.campaign.pricingConfig.variants,t=100*Math.random();let n=0;for(const a of i)if(n+=a.trafficPercent,t<=n)return a;return i[0]}forceVariantSelection(i){const t=i.variantId;this.updateUrlWithVariant(t),this.triggerVariantChange(t),this.dispatchVariantChangeEvent(t),console.log(`[Proovd] Forced variant selection: ${t} (${i.name})`)}updateUrlWithVariant(i){const t=new URL(window.location.href);t.searchParams.set("variant",i),window.history.replaceState({},"",t.toString())}triggerVariantChange(i){const t=document.querySelector('select[name="id"]');if(t)return t.value=i,void t.dispatchEvent(new Event("change",{bubbles:!0}));const n=document.querySelector(`input[name="id"][value="${i}"]`);if(n)return n.checked=!0,void n.dispatchEvent(new Event("change",{bubbles:!0}));const a=document.querySelector(`[data-variant-id="${i}"], [data-option-value][data-variant="${i}"]`);a&&a.click()}dispatchVariantChangeEvent(i){window.dispatchEvent(new CustomEvent("variant:change",{detail:{variant:{id:parseInt(i)}}})),document.dispatchEvent(new CustomEvent("shopify:variant:change",{detail:{variantId:i}}))}execute(){if(!this.isProductPage())return null;const i=this.getAssignedVariant();return"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{this.forceVariantSelection(i)}):setTimeout(()=>{this.forceVariantSelection(i)},100),i}async trackImpression(i,t){if(this.assignedVariant)try{await fetch(`${i}/track`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({siteId:t,campaignId:this.campaign.id,eventType:"impression",variantId:this.assignedVariant.variantId,price:this.assignedVariant.price,cost:this.assignedVariant.cost||0})})}catch(i){console.error("[Proovd] Failed to track impression:",i)}}}class n{constructor(i){if(this.isInitialized=!1,this.options={debug:!1,...i},!this.options.apiUrl){const i="undefined"!=typeof window&&"localhost"!==window.location.hostname&&!window.location.hostname.includes("127.0.0.1");this.options.apiUrl=i?"https://proovd.in/api":"http://localhost:3000/api"}this.log("ProovdCRO initialized with options:",this.options)}async init(){if(this.isInitialized)this.log("Already initialized");else try{const i=await this.fetchCampaigns();if(0===i.length)return void this.log("No active pricing campaigns found");for(const t of i)this.executePricingCampaign(t);this.isInitialized=!0,this.log("ProovdCRO initialized successfully")}catch(i){console.error("ProovdCRO: Failed to initialize",i)}}async fetchCampaigns(){let i="";if(this.options.websiteId)i=`siteId=${this.options.websiteId}`;else{if(!this.options.shopDomain)return this.log("No websiteId or shop domain available"),[];i=`shop=${this.options.shopDomain}`}try{const t=`${this.options.apiUrl}/campaigns?${i}&type=pricing`;this.log("Fetching campaigns from:",t);const n=await fetch(t),a=await n.json();if(a.success&&Array.isArray(a.campaigns)){const i=a.campaigns.filter(i=>"pricing"===i.type&&"running"===i.status&&i.pricingConfig);return this.log(`Found ${i.length} active pricing campaigns`),i}return[]}catch(i){return console.error("ProovdCRO: Failed to fetch campaigns",i),[]}}executePricingCampaign(i){this.log(`Executing pricing campaign: ${i.id}`);const n=new t({id:i.id,type:"pricing",pricingConfig:i.pricingConfig}).execute();n&&(this.log(`Assigned variant: ${n.variantId} (${n.name})`),this.trackImpression(i.id,n))}async trackImpression(i,t){try{await fetch(`${this.options.apiUrl}/track`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({siteId:this.options.websiteId,campaignId:i,eventType:"impression",variantId:t.variantId,price:t.price,cost:t.cost||0})})}catch(i){console.error("[Proovd] Failed to track impression:",i)}}log(...i){this.options.debug&&console.log("[ProovdCRO]",...i)}}if("undefined"!=typeof window){const i=document.currentScript;let t=null;if(i?.src)try{t=new URL(i.src).searchParams.get("shop")}catch(i){}const a=i?.dataset?.websiteId;if(a||t){const e=new n({websiteId:a,shopDomain:t||void 0,apiUrl:i?.dataset?.apiUrl,debug:"true"===i?.dataset?.debug||!0});e.init(),window.proovd=e,console.log("[Proovd] Auto-initialized with:",{websiteId:a,shopDomain:t})}else console.warn("[Proovd] No websiteId or shop domain found. Widget will not initialize.")}return i.ProovdCRO=n,i.default=n,Object.defineProperty(i,"__esModule",{value:!0}),i}({});
//# sourceMappingURL=proovd-pulse-widget.js.map
